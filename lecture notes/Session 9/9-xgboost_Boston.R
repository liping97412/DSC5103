##########################################################
# DSC5103 Statistics
# Session 9. Trees III: Boosting
# 2018.10
#
# Fitting Gradient Boosting Machine
# demo for Regression problems
# using the Boston housing dataset in package "MASS"
##########################################################
library("ggplot2")


### the Boston housing data
library("MASS")
?Boston
summary(Boston)
Boston$chas <- as.factor(Boston$chas)

# separate training and test
set.seed(2345)
train.index <- sample(1:nrow(Boston), nrow(Boston)/2)
test.index <- -train.index
x.test <- Boston[test.index, -14]
y.test <- Boston[test.index, "medv"]



## XGboost
library("xgboost")

x.train <- model.matrix(medv ~ ., data=Boston[train.index, ])[, -1]
y.train <- Boston[train.index, "medv"]
x.test <- model.matrix(medv ~ ., data=Boston[-train.index, ])[ , -1]
y.test <- Boston[-train.index, "medv"]

## Construct a dense matrix for xgboost to consume
dtrain <- xgb.DMatrix(data=x.train, label=y.train)
dtrain
str(dtrain)
head(getinfo(dtrain, 'label'))


# fit an XGBoost model
?xgboost
set.seed(321)
xgb1 <- xgboost(data=dtrain, objective="reg:linear", 
                nrounds=5000, max_depth=4, eta=0.005, subsample=0.5, colsample_bytree=1)
str(xgb1)


# predict
?predict.xgb.Booster
yhat.xgb1 <- predict(xgb1, x.test)
plot(yhat.xgb1, y.test)
abline(0,1)
mse.xgb1 <- mean((yhat.xgb1 - y.test)^2)


# CV for optimal ntree
?xgb.cv
set.seed(321)
xgb.cv1 <- xgb.cv(data = dtrain, objective="reg:linear", 
                  nrounds=5000, max_depth=4, eta=0.005, subsample=0.5, colsample_bytree=1,
                  nfold=10, early_stopping_rounds=100)
str(xgb.cv1)
xgb.cv1$best_ntreelimit
plot(xgb.cv1$evaluation_log$iter, xgb.cv1$evaluation_log$test_rmse_mean, type="l")



### TUNING
#...

# max_depth   eta subsample colsample  n.max nrounds   cv.err
# 1           1 5e-02      0.50       0.6   2000     587 4.643780
# 2           1 5e-02      0.50       0.8   2000     140 4.981409
# 3           1 5e-02      0.50       1.0   2000     465 3.702649
# 4           1 5e-02      0.75       0.6   2000    1310 4.479793
# 5           1 5e-02      0.75       0.8   2000     226 4.848925
# 6           1 5e-02      0.75       1.0   2000     553 3.684791
# 7           1 5e-02      1.00       0.6   2000    1990 4.223354
# 8           1 5e-02      1.00       0.8   2000     299 4.780641
# 9           1 5e-02      1.00       1.0   2000     603 3.716311
# 10          1 1e-02      0.50       0.6  10000    1366 4.752921
# 11          1 1e-02      0.50       0.8  10000     838 4.879061
# 12          1 1e-02      0.50       1.0  10000    1444 3.790440
# 13          1 1e-02      0.75       0.6  10000    1819 4.654705
# 14          1 1e-02      0.75       0.8  10000     903 4.874705
# 15          1 1e-02      0.75       1.0  10000    2152 3.723149
# 16          1 1e-02      1.00       0.6  10000    8956 4.222777
# 17          1 1e-02      1.00       0.8  10000    1490 4.778780
# 18          1 1e-02      1.00       1.0  10000    3032 3.713859
# 19          1 5e-03      0.50       0.6  20000    3188 4.718188
# 20          1 5e-03      0.50       0.8  20000    1490 4.876216
# 21          1 5e-03      0.50       1.0  20000    3804 3.747360
# 22          1 5e-03      0.75       0.6  20000    2586 4.713576
# 23          1 5e-03      0.75       0.8  20000    1968 4.878517
# 24          1 5e-03      0.75       1.0  20000    4086 3.733787
# 25          1 5e-03      1.00       0.6  20000   17670 4.223026
# 26          1 5e-03      1.00       0.8  20000    3004 4.779804
# 27          1 5e-03      1.00       1.0  20000    6062 3.715609
# 28          1 1e-03      0.50       0.6 100000    8293 4.840254
# 29          1 1e-03      0.50       0.8 100000    7378 4.881424
# 30          1 1e-03      0.50       1.0 100000   14593 3.780732
# 31          1 1e-03      0.75       0.6 100000   15777 4.685252
# 32          1 1e-03      0.75       0.8 100000    8386 4.878575
# 33          1 1e-03      0.75       1.0 100000   19484 3.741124
# 34          1 1e-03      1.00       0.6 100000   89120 4.223121
# 35          1 1e-03      1.00       0.8 100000   14935 4.780415
# 36          1 1e-03      1.00       1.0 100000   30036 3.715495
# 37          1 5e-04      0.50       0.6 200000   18051 4.825007
# 38          1 5e-04      0.50       0.8 200000   13891 4.900151
# 39          1 5e-04      0.50       1.0 200000   21868 3.843507
# 40          1 5e-04      0.75       0.6 200000   35331 4.666820
# 41          1 5e-04      0.75       0.8 200000   16678 4.880487
# 42          1 5e-04      0.75       1.0 200000   36957 3.753556
# 43          1 5e-04      1.00       0.6 200000  177450 4.223319
# 44          1 5e-04      1.00       0.8 200000   29805 4.780486
# 45          1 5e-04      1.00       1.0 200000   59585 3.715655
# 46          2 5e-02      0.50       0.6   1414     552 4.264121
# 47          2 5e-02      0.50       0.8   1414     937 4.188069
# 48          2 5e-02      0.50       1.0   1414     543 3.303624
# 49          2 5e-02      0.75       0.6   1414     260 4.287269
# 50          2 5e-02      0.75       0.8   1414     458 4.276776
# 51          2 5e-02      0.75       1.0   1414     445 3.262102
# 52          2 5e-02      1.00       0.6   1414     449 4.254638
# 53          2 5e-02      1.00       0.8   1414     606 4.176495
# 54          2 5e-02      1.00       1.0   1414     294 3.452208
# 55          2 1e-02      0.50       0.6   7071     864 4.300406
# 56          2 1e-02      0.50       0.8   7071    2082 4.150018
# 57          2 1e-02      0.50       1.0   7071    2628 3.231165
# 58          2 1e-02      0.75       0.6   7071    1350 4.314903
# 59          2 1e-02      0.75       0.8   7071    2026 4.227683
# 60          2 1e-02      0.75       1.0   7071    1838 3.309899
# 61          2 1e-02      1.00       0.6   7071    2014 4.248087
# 62          2 1e-02      1.00       0.8   7071    1221 4.294218
# 63          2 1e-02      1.00       1.0   7071    1694 3.415480
# 64          2 5e-03      0.50       0.6  14142    2174 4.318084
# 65          2 5e-03      0.50       0.8  14142    2173 4.242889
# 66          2 5e-03      0.50       1.0  14142    5534 3.221522
# 67          2 5e-03      0.75       0.6  14142    2085 4.299724
# 68          2 5e-03      0.75       0.8  14142    3399 4.252546
# 69          2 5e-03      0.75       1.0  14142    3725 3.283730
# 70          2 5e-03      1.00       0.6  14142    2969 4.266881
# 71          2 5e-03      1.00       0.8  14142    2411 4.286973
# 72          2 5e-03      1.00       1.0  14142    3633 3.413489
# 73          2 1e-03      0.50       0.6  70711   10094 4.328953
# 74          2 1e-03      0.50       0.8  70711   14538 4.220047
# 75          2 1e-03      0.50       1.0  70711   17326 3.286099
# 76          2 1e-03      0.75       0.6  70711    9980 4.323338
# 77          2 1e-03      0.75       0.8  70711   14556 4.257459
# 78          2 1e-03      0.75       1.0  70711   13606 3.338656
# 79          2 1e-03      1.00       0.6  70711    6451 4.541647
# 80          2 1e-03      1.00       0.8  70711   12337 4.296245
# 81          2 1e-03      1.00       1.0  70711   14261 3.425648
# 82          2 5e-04      0.50       0.6 141421   21807 4.312274
# 83          2 5e-04      0.50       0.8 141421   25414 4.225992
# 84          2 5e-04      0.50       1.0 141421   34146 3.282922
# 85          2 5e-04      0.75       0.6 141421   22663 4.309559
# 86          2 5e-04      0.75       0.8 141421   28174 4.261056
# 87          2 5e-04      0.75       1.0 141421   36217 3.308837
# 88          2 5e-04      1.00       0.6 141421   12951 4.541904
# 89          2 5e-04      1.00       0.8 141421   24341 4.297957
# 90          2 5e-04      1.00       1.0 141421   34407 3.412878
# 91          4 5e-02      0.50       0.6   1000     389 4.083189
# 92          4 5e-02      0.50       0.8   1000     372 4.035067
# 93          4 5e-02      0.50       1.0   1000     330 3.238209
# 94          4 5e-02      0.75       0.6   1000     277 4.214727
# 95          4 5e-02      0.75       0.8   1000     417 3.989984
# 96          4 5e-02      0.75       1.0   1000     454 3.223925
# 97          4 5e-02      1.00       0.6   1000     192 4.133283
# 98          4 5e-02      1.00       0.8   1000     242 4.056504
# 99          4 5e-02      1.00       1.0   1000     168 3.292724
# 100         4 1e-02      0.50       0.6   5000    1340 4.077055
# 101         4 1e-02      0.50       0.8   5000    1533 3.962814
# 102         4 1e-02      0.50       1.0   5000    1410 3.146747
# 103         4 1e-02      0.75       0.6   5000    1596 4.104290
# 104         4 1e-02      0.75       0.8   5000    1986 3.930191
# 105         4 1e-02      0.75       1.0   5000    1654 3.214942
# 106         4 1e-02      1.00       0.6   5000     997 4.104720
# 107         4 1e-02      1.00       0.8   5000    1002 4.088546
# 108         4 1e-02      1.00       1.0   5000     837 3.338521
# 109         4 5e-03      0.50       0.6  10000    2294 4.068809
# 110         4 5e-03      0.50       0.8  10000    2559 4.001663
# 111         4 5e-03      0.50       1.0  10000    2886 3.138758
# 112         4 5e-03      0.75       0.6  10000    1937 4.132992
# 113         4 5e-03      0.75       0.8  10000    3335 3.905821
# 114         4 5e-03      0.75       1.0  10000    2782 3.203156
# 115         4 5e-03      1.00       0.6  10000    1984 4.076951
# 116         4 5e-03      1.00       0.8  10000    2059 4.085512
# 117         4 5e-03      1.00       1.0  10000    1745 3.328637
# 118         4 1e-03      0.50       0.6  50000   11264 4.102432
# 119         4 1e-03      0.50       0.8  50000   12743 3.970175
# 120         4 1e-03      0.50       1.0  50000   12299 3.147048
# 121         4 1e-03      0.75       0.6  50000   11091 4.129225
# 122         4 1e-03      0.75       0.8  50000   13939 3.923674
# 123         4 1e-03      0.75       1.0  50000   12547 3.197836
# 124         4 1e-03      1.00       0.6  50000    9118 4.122332
# 125         4 1e-03      1.00       0.8  50000    6787 4.109497
# 126         4 1e-03      1.00       1.0  50000    8178 3.331607
# 127         4 5e-04      0.50       0.6 100000   19993 4.101038
# 128         4 5e-04      0.50       0.8 100000   19451 4.017271
# 129         4 5e-04      0.50       1.0 100000   24149 3.143839
# 130         4 5e-04      0.75       0.6 100000   19644 4.123068
# 131         4 5e-04      0.75       0.8 100000   27359 3.920332
# 132         4 5e-04      0.75       1.0 100000   24742 3.205993
# 133         4 5e-04      1.00       0.6 100000   19357 4.103342
# 134         4 5e-04      1.00       0.8 100000   13407 4.105832
# 135         4 5e-04      1.00       1.0 100000   15571 3.326408
# 136         6 5e-02      0.50       0.6    816     260 4.197149
# 137         6 5e-02      0.50       0.8    816     374 4.091372
# 138         6 5e-02      0.50       1.0    816     338 3.122814
# 139         6 5e-02      0.75       0.6    816     246 4.192523
# 140         6 5e-02      0.75       0.8    816     181 3.887424
# 141         6 5e-02      0.75       1.0    816     207 3.173932
# 142         6 5e-02      1.00       0.6    816     215 4.369755
# 143         6 5e-02      1.00       0.8   816     214 3.841979
# 144         6 5e-02      1.00       1.0   816     143 3.214617
# 145         6 1e-02      0.50       0.6  4082    1117 4.125739
# 146         6 1e-02      0.50       0.8  4082    1330 3.972056
# 147         6 1e-02      0.50       1.0  4082    1678 3.158408
# 148         6 1e-02      0.75       0.6  4082     948 4.137742
# 149         6 1e-02      0.75       0.8  4082    1429 3.886921
# 150         6 1e-02      0.75       1.0  4082    1605 3.165408
# 151         6 1e-02      1.00       0.6  4082    1029 4.346764
# 152         6 1e-02      1.00       0.8  4082     844 3.940849
# 153         6 1e-02      1.00       1.0  4082    1019 3.206798
# 154         6 5e-03      0.50       0.6  8165    1933 4.096295
# 155         6 5e-03      0.50       0.8  8165    2682 3.978500
# 156         6 5e-03      0.50       1.0  8165    3342 3.099753
# 157         6 5e-03      0.75       0.6  8165    2133 4.175999
# 158         6 5e-03      0.75       0.8  8165    2302 3.823069
# 159         6 5e-03      0.75       1.0  8165    2234 3.113785
# 160         6 5e-03      1.00       0.6  8165    1802 4.337956
# 161         6 5e-03      1.00       0.8  8165    1591 3.944855
# 162         6 5e-03      1.00       1.0  8165    1402 3.228342
# 163         6 1e-03      0.50       0.6 40825    9314 4.095313
# 164         6 1e-03      0.50       0.8 40825   10872 3.960524
# 165         6 1e-03      0.50       1.0 40825   13560 3.119019
# 166         6 1e-03      0.75       0.6 40825    9657 4.129453
# 167         6 1e-03      0.75       0.8 40825   11599 3.851540
# 168         6 1e-03      0.75       1.0 40825   12530 3.157521
# 169         6 1e-03      1.00       0.6 40825    6841 4.409738
# 170         6 1e-03      1.00       0.8 40825    5916 3.989158
# 171         6 1e-03      1.00       1.0 40825    6003 3.237290
# 172         6 5e-04      0.50       0.6 81650   16807 4.116121
# 173         6 5e-04      0.50       0.8 81650   23542 3.985205
# 174         6 5e-04      0.50       1.0 81650   22241 3.099014
# 175         6 5e-04      0.75       0.6 81650   17544 4.154301
# 176         6 5e-04      0.75       0.8 81650   22778 3.874822
# 177         6 5e-04      0.75       1.0 81650   25999 3.150491
# 178         6 5e-04      1.00       0.6 81650   15954 4.360868
# 179         6 5e-04      1.00       0.8 81650   11895 3.995785
# 180         6 5e-04      1.00       1.0 81650   14339 3.235045
# 181         8 5e-02      0.50       0.6   707     184 4.144833
# 182         8 5e-02      0.50       0.8   707     280 4.038726
# 183         8 5e-02      0.50       1.0   707     566 3.118065
# 184         8 5e-02      0.75       0.6   707     213 4.183215
# 185         8 5e-02      0.75       0.8   707     203 3.878688
# 186         8 5e-02      0.75       1.0   707     194 3.145363
# 187         8 5e-02      1.00       0.6   707     230 4.436971
# 188         8 5e-02      1.00       0.8   707     253 3.995427
# 189         8 5e-02      1.00       1.0   707     218 3.214897
# 190         8 1e-02      0.50       0.6  3536    1048 4.146635
# 191         8 1e-02      0.50       0.8  3536    1250 3.969320
# 192         8 1e-02      0.50       1.0  3536    2177 3.020227
# 193         8 1e-02      0.75       0.6  3536     704 4.194541
# 194         8 1e-02      0.75       0.8  3536     673 3.901334
# 195         8 1e-02      0.75       1.0  3536    1547 3.161491
# 196         8 1e-02      1.00       0.6  3536     975 4.401487
# 197         8 1e-02      1.00       0.8  3536     618 4.062021
# 198         8 1e-02      1.00       1.0  3536    1043 3.253711
# 199         8 5e-03      0.50       0.6  7071    1667 4.176761
# 200         8 5e-03      0.50       0.8  7071    2819 3.988104
# 201         8 5e-03      0.50       1.0  7071    2736 3.113813
# 202         8 5e-03      0.75       0.6  7071    1688 4.188162
# 203         8 5e-03      0.75       0.8  7071    1309 3.866871
# 204         8 5e-03      0.75       1.0  7071    2469 3.129670
# 205         8 5e-03      1.00       0.6  7071    1531 4.409347
# 206         8 5e-03      1.00       0.8  7071    1414 3.993265
# 207         8 5e-03      1.00       1.0  7071    1305 3.259753
# 208         8 1e-03      0.50       0.6 35355    7787 4.146953
# 209         8 1e-03      0.50       0.8 35355    7822 4.000997
# 210         8 1e-03      0.50       1.0 35355   16493 3.069026
# 211         8 1e-03      0.75       0.6 35355    7641 4.198051
# 212         8 1e-03      0.75       0.8 35355    6197 3.881385
# 213         8 1e-03      0.75       1.0 35355   11318 3.143510
# 214         8 1e-03      1.00       0.6 35355    7614 4.371541
# 215         8 1e-03      1.00       0.8 35355    6014 4.054431
# 216         8 1e-03      1.00       1.0 35355    6086 3.314790
# 217         8 5e-04      0.50       0.6 70711   16657 4.124199
# 218         8 5e-04      0.50       0.8 70711   15995 4.014192
# 219         8 5e-04      0.50       1.0 70711   24098 3.087380
# 220         8 5e-04      0.75       0.6 70711   15848 4.211547
# 221         8 5e-04      0.75       0.8 70711   12276 3.899926
# 222         8 5e-04      0.75       1.0 70711   25423 3.147874
# 223         8 5e-04      1.00       0.6 70711   13991 4.392260
# 224         8 5e-04      1.00       0.8 70711   12232 4.049467
# 225         8 5e-04      1.00       1.0 70711   11531 3.320970

max_depth.opt <- 8
eta.opt <- 0.01
subsample.opt <- 0.5
nrounds.opt <- 2177
colsample.opt <- 1

# final model
set.seed(321)
xgb2 <- xgboost(data=dtrain, objective="reg:linear",
                nround=nrounds.opt, max.depth=max_depth.opt, eta=eta.opt, subsample=subsample.opt, colsample_bytree=colsample.opt)

# predict
yhat.xgb2 <- predict(xgb2, x.test)
plot(yhat.xgb2, y.test)
abline(0,1)
mse.xgb2 <- mean((yhat.xgb2 - y.test)^2)



# variable importance
importance_matrix <- xgb.importance(model = xgb2, feature_names = colnames(x.train))
importance_matrix
xgb.plot.importance(importance_matrix=importance_matrix)



### Partial Dependence by pdp
# https://github.com/bgreenwell/pdp
library("pdp")
pd1 <- partial(xgb2, train=x.train, pred.var = "rm", chull = TRUE)
# plot using lattice
plotPartial(pd1)
# ggplot2 version
autoplot(pd1)

plotPartial(partial(xgb2, train=x.train, pred.var = "crim", chull = TRUE))
plotPartial(partial(xgb2, train=x.train, pred.var = "rad", chull = TRUE))
plotPartial(partial(xgb2, train=x.train, pred.var = "chas1", chull = TRUE))


# 2-D partial plot
pd2 <- partial(xgb2, train=x.train, pred.var = c("lstat", "rm"), chull=TRUE)
# pd2 <- partial(boston.rf, pred.var = c("lstat", "rm"), chull=TRUE)
head(pd2)

plotPartial(pd2)
autoplot(pd2, contour = TRUE)


library("tidyr")
pd2.wide <- pd2 %>% spread(key="rm", value="yhat")
lstat <- pd2.wide$lstat
rm <- as.numeric(colnames(pd2.wide)[-1])
library("plotly")
plot_ly(x=lstat, y=rm, z=as.matrix(pd2.wide[, -1]), type = "surface") 

